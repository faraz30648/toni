<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TONI — INTEL</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div class="video-background">
        <video autoplay muted loop playsinline id="bg-video">
            <source src="https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerMeltdowns.mp4" type="video/mp4">
        </video>
        <div class="video-overlay"></div>
    </div>

    <nav class="navbar">
        <a href="index.html" class="brand-logo">TONI</a>
        <button class="mobile-menu-btn" aria-label="Toggle Menu" onclick="toggleMenu()">
            <span id="menu-icon">☰</span>
        </button>
        <ul class="nav-links">
            <li><a href="index.html" class="mono">Portal</a></li>
            <li><a href="drops.html" class="mono">Drops</a></li>
            <li><a href="blog.html" class="active mono">Intel</a></li>
            <li><a href="access.html" class="mono">Access</a></li>
        </ul>
    </nav>

    <main class="container section tilt-element" style="padding-top: 120px;">
        <header style="margin-bottom: 3rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
            <h1 class="mono dim">MARKET INTEL</h1>
            <p class="mono text-sub" style="margin-top: 1rem; max-width: 500px;">
                Live feed from the underground.<br>
                <span style="color: #ffd700;">// STATUS: CONNECTED TO GLOBAL NETWORK</span>
            </p>
        </header>

        <div id="blog-grid" class="blog-list">
            <div class="loading-state mono">ESTABLISHING CONNECTION...</div>
        </div>
    </main>

    <script>
        function toggleMenu() {
            const nav = document.querySelector('.nav-links');
            const btn = document.getElementById('menu-icon');
            nav.classList.toggle('active');
            if (nav.classList.contains('active')) {
                btn.innerHTML = '✕';
                document.body.style.overflow = 'hidden'; 
            } else {
                btn.innerHTML = '☰';
                document.body.style.overflow = 'auto';
            }
        }

        // --- REAL API FETCHING ---
        const FEED_GLOBAL = 'https://api.rss2json.com/v1/api.json?rss_url=https%3A%2F%2Fsneakernews.com%2Ffeed%2F';
        const FEED_INDIA = 'https://api.rss2json.com/v1/api.json?rss_url=https%3A%2F%2Fnews.google.com%2Frss%2Fsearch%3Fq%3Dcollectibles%2Bmarket%2Bindia%26hl%3Den-IN%26gl%3DIN%26ceid%3DIN%3Aen';

        async function fetchMarketIntel() {
            const container = document.getElementById('blog-grid');
            
            try {
                const [globalRes, indiaRes] = await Promise.all([
                    fetch(FEED_GLOBAL),
                    fetch(FEED_INDIA)
                ]);

                const globalData = await globalRes.json();
                const indiaData = await indiaRes.json();

                let articles = [];

                const processItems = (items, tag, source) => {
                    if (!items) return [];
                    return items.map(item => {
                        // Extract ONLY the first paragraph
                        const rawContent = item.description || item.content;
                        const firstPara = extractFirstParagraph(rawContent);
                        
                        return {
                            title: item.title,
                            date: item.pubDate.split(' ')[0],
                            content: firstPara, // Saving only the clean paragraph
                            link: item.link,
                            image: item.thumbnail || item.enclosure?.link || '',
                            tag: tag,
                            source: source
                        };
                    });
                };

                // Merge Data
                articles = [
                    ...processItems(globalData.items, 'GLOBAL', 'SNEAKERNEWS'),
                    ...processItems(indiaData.items, 'INDIA', 'MARKET_WIRE')
                ];

                // Sort by date
                articles.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Render
                container.innerHTML = '';
                
                articles.forEach((post, index) => {
                    const article = document.createElement('article');
                    article.className = 'blog-card';
                    const safeId = `post_${index}`;
                    
                    // Blog Card View
                    article.innerHTML = `
                        <div class="blog-meta mono">
                            <span class="blog-date">${post.date}</span>
                            <span class="blog-cat" style="color: ${post.tag === 'INDIA' ? '#ff9933' : '#ffd700'}">[${post.tag}]</span>
                        </div>
                        <h2 class="blog-title">${post.title}</h2>
                        <p class="blog-snippet mono">${post.content.substring(0, 100)}...</p>
                        <div class="blog-tags">
                            <span class="tag">#${post.source}</span>
                        </div>
                        <button onclick="readArticle('${safeId}')" class="read-btn mono">ACCESS_DATA ></button>
                    `;
                    
                    sessionStorage.setItem(safeId, JSON.stringify(post));
                    container.appendChild(article);
                });

            } catch (error) {
                console.error(error);
                container.innerHTML = `<div class="error-state mono">SIGNAL LOST: UNABLE TO FETCH EXTERNAL DATA</div>`;
            }
        }

        // --- NEW: EXTRACT FIRST PARAGRAPH ONLY ---
        function extractFirstParagraph(html) {
            if (!html) return "";
            
            // 1. Create temp element to parse HTML
            const temp = document.createElement('div');
            temp.innerHTML = html;

            // 2. Try to find the first <p> tag with substantial text
            const paragraphs = temp.getElementsByTagName('p');
            let foundText = "";

            for (let p of paragraphs) {
                // Remove internal links/junk from the p tag before checking
                let text = p.textContent || p.innerText;
                // We look for a paragraph longer than 40 chars to avoid "Caption" or "Byline"
                if (text && text.length > 40) {
                    foundText = text.trim();
                    break;
                }
            }

            // 3. Fallback: If no good <p> found (common in Google News), use the raw text
            if (!foundText) {
                foundText = temp.textContent || temp.innerText || "";
            }

            // 4. CLEANING: Remove the specific "RSS Footer" junk using Regex
            // Removes "The post... appeared first on..."
            foundText = foundText.replace(/The post.*?appeared first on.*/s, "");
            // Removes "Copyright..."
            foundText = foundText.replace(/©.*/s, "");
            // Removes "Permalink..."
            foundText = foundText.replace(/Permalink.*/s, "");
            // Removes "No comment"
            foundText = foundText.replace(/No comment.*/s, "");
            
            return foundText;
        }

        function readArticle(id) {
            window.location.href = `article.html?id=${id}`;
        }

        document.addEventListener('DOMContentLoaded', fetchMarketIntel);
    </script>
</body>
</html>
